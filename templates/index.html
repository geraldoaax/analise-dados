<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>An√°lise de Ciclos</title>
    <script src="https://cdn.plot.ly/plotly-3.1.0.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
      }
      .container {
        display: flex;
      }
      .menu {
        width: 200px;
        border-right: 1px solid #ccc;
        padding-right: 20px;
      }
      .content {
        flex-grow: 1;
        padding-left: 20px;
      }
      ul {
        list-style-type: none;
        padding: 0;
      }
      li a {
        display: block;
        color: #000;
        padding: 8px 16px;
        text-decoration: none;
      }
      li a.active {
        background-color: #4caf50;
        color: white;
      }
      li a:hover:not(.active) {
        background-color: #555;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="menu">
        <h2>An√°lises</h2>
        <ul>
          <li>
            <a
              href="#"
              class="active"
              onclick="showAnalysis('cycles_by_year_month')"
              >Ciclos por Ano/M√™s</a
            >
          </li>
          <li>
            <a href="#" onclick="showAnalysis('cycles_by_tipo_input')"
              >Ciclos por Tipo Input</a
            >
          </li>
          <!-- Add more menu items here -->
        </ul>
      </div>
      <div class="content">
        <div id="chart"></div>
      </div>
    </div>

    <script>
      function showAnalysis(analysisType) {
        // Atualizar menu ativo
        const menuLinks = document.querySelectorAll(".menu a");
        menuLinks.forEach((link) => link.classList.remove("active"));

        if (analysisType === "cycles_by_year_month") {
          menuLinks[0].classList.add("active");
        } else if (analysisType === "cycles_by_tipo_input") {
          menuLinks[1].classList.add("active");
        }

        if (analysisType === "cycles_by_year_month") {
          console.log("üöÄ [FRONTEND] Iniciando an√°lise de ciclos por ano/m√™s");
          const startTime = performance.now();

          // Limpar o gr√°fico e mostrar carregamento
          document.getElementById("chart").innerHTML =
            '<div style="text-align: center; padding: 50px;">Carregando dados...</div>';

          console.log(
            "üåê [FRONTEND] Fazendo requisi√ß√£o para /api/cycles_by_year_month"
          );
          const requestStart = performance.now();

          fetch("/api/cycles_by_year_month")
            .then((response) => {
              const requestTime = performance.now() - requestStart;
              console.log(
                `üåê [FRONTEND] Resposta recebida em ${requestTime.toFixed(2)}ms`
              );
              console.log(
                `üåê [FRONTEND] Status: ${response.status} ${response.statusText}`
              );
              console.log(
                `üåê [FRONTEND] Headers:`,
                Object.fromEntries(response.headers.entries())
              );

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              return response.json();
            })
            .then((data) => {
              const parseTime = performance.now() - requestStart;
              console.log(
                `üìä [FRONTEND] JSON parseado em ${parseTime.toFixed(2)}ms`
              );
              console.log("üìä [FRONTEND] Dados recebidos:", data);

              // Verificar se h√° erro na resposta
              if (data.error) {
                console.error(
                  "‚ùå [FRONTEND] Erro retornado pela API:",
                  data.error
                );
                document.getElementById(
                  "chart"
                ).innerHTML = `<div style="color: red; text-align: center; padding: 50px;">Erro: ${data.error}</div>`;
                return;
              }

              // Verificar se h√° dados
              if (!data || data.length === 0) {
                console.warn(
                  "‚ö†Ô∏è [FRONTEND] Nenhum dado encontrado na resposta"
                );
                document.getElementById("chart").innerHTML =
                  '<div style="text-align: center; padding: 50px;">Nenhum dado encontrado.</div>';
                return;
              }

              console.log(`üìà [FRONTEND] ${data.length} per√≠odos encontrados`);
              console.log(
                "üìà [FRONTEND] Primeiros registros:",
                data.slice(0, 3)
              );

              const x_values = data.map((item) => item.AnoMes);
              const y_values = data.map((item) => item.count);

              console.log("üìä [FRONTEND] Valores X:", x_values);
              console.log("üìä [FRONTEND] Valores Y:", y_values);

              const processStart = performance.now();

              const plotData = [
                {
                  x: x_values,
                  y: y_values,
                  type: "bar",
                  marker: {
                    color: y_values.map((v, i) => {
                      // Gradiente de cores baseado no valor
                      const intensity =
                        (v - Math.min(...y_values)) /
                        (Math.max(...y_values) - Math.min(...y_values));
                      const r = Math.floor(31 + intensity * (74 - 31)); // De azul escuro para azul claro
                      const g = Math.floor(119 + intensity * (158 - 119));
                      const b = Math.floor(180 + intensity * (255 - 180));
                      return `rgb(${r},${g},${b})`;
                    }),
                    line: {
                      color: "#0d47a1",
                      width: 1,
                    },
                    opacity: 0.8,
                  },
                  text: y_values.map((v) => {
                    // Formatar n√∫meros com separador de milhares
                    return v.toLocaleString("pt-BR");
                  }),
                  textposition: "outside",
                  textfont: {
                    size: 10,
                    color: "#333",
                    family: "Arial, sans-serif",
                  },
                  hovertemplate:
                    "<b>%{x}</b><br>" +
                    "Ciclos: %{y:,.0f}<br>" +
                    "<extra></extra>",
                },
              ];

              const layout = {
                title: {
                  text: "Contagem de Ciclos por Ano/M√™s",
                  font: {
                    size: 20,
                    color: "#333",
                    family: "Arial, sans-serif",
                  },
                },
                xaxis: {
                  title: {
                    text: "Per√≠odo (Ano-M√™s)",
                    font: {
                      size: 14,
                      color: "#555",
                    },
                  },
                  tickangle: -45,
                  tickfont: {
                    size: 11,
                    color: "#666",
                  },
                  gridcolor: "#e1e5e9",
                  linecolor: "#c1c7cd",
                },
                yaxis: {
                  title: {
                    text: "Quantidade de Ciclos",
                    font: {
                      size: 14,
                      color: "#555",
                    },
                  },
                  tickfont: {
                    size: 11,
                    color: "#666",
                  },
                  gridcolor: "#e1e5e9",
                  linecolor: "#c1c7cd",
                  zeroline: false,
                },
                margin: {
                  l: 80,
                  r: 40,
                  t: 100,
                  b: 120,
                },
                height: 500,
                plot_bgcolor: "#fafbfc",
                paper_bgcolor: "#ffffff",
                bargap: 0.3,
                showlegend: false,
              };

              const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ["pan2d", "lasso2d"],
              };

              console.log("üìä [FRONTEND] Criando gr√°fico com Plotly...");
              const plotStart = performance.now();

              Plotly.newPlot("chart", plotData, layout, config).then(() => {
                const plotTime = performance.now() - plotStart;
                const totalTime = performance.now() - startTime;
                console.log(
                  `‚úÖ [FRONTEND] Gr√°fico criado em ${plotTime.toFixed(2)}ms`
                );
                console.log(
                  `üéâ [FRONTEND] Processo completo em ${totalTime.toFixed(2)}ms`
                );
              });
            })
            .catch((error) => {
              const errorTime = performance.now() - startTime;
              console.error(
                `‚ùå [FRONTEND] Erro ap√≥s ${errorTime.toFixed(2)}ms:`,
                error
              );
              console.error("‚ùå [FRONTEND] Stack trace:", error.stack);

              let errorMessage = error.message;
              if (
                error.name === "TypeError" &&
                error.message.includes("fetch")
              ) {
                errorMessage =
                  "Erro de conex√£o com o servidor. Verifique se o Flask est√° rodando.";
              }

              document.getElementById(
                "chart"
              ).innerHTML = `<div style="color: red; text-align: center; padding: 50px;">
                 <h3>Erro ao carregar dados</h3>
                 <p><strong>Mensagem:</strong> ${errorMessage}</p>
                 <p><strong>Tempo:</strong> ${errorTime.toFixed(2)}ms</p>
                 <p><small>Verifique o console para mais detalhes</small></p>
               </div>`;
            });
        } else if (analysisType === "cycles_by_tipo_input") {
          console.log(
            "üöÄ [FRONTEND] Iniciando an√°lise de ciclos por tipo input"
          );
          const startTime = performance.now();

          // Limpar o gr√°fico e mostrar carregamento
          document.getElementById("chart").innerHTML =
            '<div style="text-align: center; padding: 50px;">Carregando dados...</div>';

          console.log(
            "üåê [FRONTEND] Fazendo requisi√ß√£o para /api/cycles_by_tipo_input"
          );
          const requestStart = performance.now();

          fetch("/api/cycles_by_tipo_input")
            .then((response) => {
              const requestTime = performance.now() - requestStart;
              console.log(
                `üåê [FRONTEND] Resposta recebida em ${requestTime.toFixed(2)}ms`
              );
              console.log(
                `üåê [FRONTEND] Status: ${response.status} ${response.statusText}`
              );

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              return response.json();
            })
            .then((data) => {
              const parseTime = performance.now() - requestStart;
              console.log(
                `üìä [FRONTEND] JSON parseado em ${parseTime.toFixed(2)}ms`
              );
              console.log("üìä [FRONTEND] Dados recebidos:", data);

              // Verificar se h√° erro na resposta
              if (data.error) {
                console.error(
                  "‚ùå [FRONTEND] Erro retornado pela API:",
                  data.error
                );
                document.getElementById(
                  "chart"
                ).innerHTML = `<div style="color: red; text-align: center; padding: 50px;">Erro: ${data.error}</div>`;
                return;
              }

              // Verificar se h√° dados
              if (!data || data.length === 0) {
                console.warn(
                  "‚ö†Ô∏è [FRONTEND] Nenhum dado encontrado na resposta"
                );
                document.getElementById("chart").innerHTML =
                  '<div style="text-align: center; padding: 50px;">Nenhum dado encontrado.</div>';
                return;
              }

              console.log(`üìà [FRONTEND] ${data.length} registros encontrados`);
              console.log(
                "üìà [FRONTEND] Primeiros registros:",
                data.slice(0, 3)
              );

              // Processar dados para barras empilhadas
              const processStart = performance.now();

              // Obter todos os per√≠odos √∫nicos e tipos √∫nicos
              const periodos = [
                ...new Set(data.map((item) => item.AnoMes)),
              ].sort();
              const tipos = [
                ...new Set(data.map((item) => item["Tipo Input"])),
              ].sort();

              console.log("üìä [FRONTEND] Per√≠odos:", periodos);
              console.log("üìä [FRONTEND] Tipos Input:", tipos);

              // Criar cores para cada tipo
              const cores = {
                "#TIMELINE-ADD": "#ff6b6b",
                "CARGA DE PRODU√á√ÉO": "#4ecdc4",
                EMBARCADO: "#45b7d1",
              };

              // Criar dados para cada tipo
              const plotData = tipos.map((tipo) => {
                const valores = periodos.map((periodo) => {
                  const registro = data.find(
                    (item) =>
                      item.AnoMes === periodo && item["Tipo Input"] === tipo
                  );
                  return registro ? registro.count : 0;
                });

                return {
                  x: periodos,
                  y: valores,
                  name: tipo,
                  type: "bar",
                  marker: {
                    color: cores[tipo] || "#95a5a6",
                    opacity: 0.8,
                    line: {
                      color: "#2c3e50",
                      width: 1,
                    },
                  },
                  text: valores.map((v) =>
                    v > 0 ? v.toLocaleString("pt-BR") : ""
                  ),
                  textposition: "inside",
                  textfont: {
                    size: 10,
                    color: "#fff",
                    family: "Arial, sans-serif",
                  },
                  hovertemplate:
                    "<b>%{x}</b><br>" +
                    "Tipo: " +
                    tipo +
                    "<br>" +
                    "Ciclos: %{y:,.0f}<br>" +
                    "<extra></extra>",
                };
              });

              const layout = {
                title: {
                  text: "Contagem de Ciclos por Tipo Input (Empilhado)",
                  font: {
                    size: 20,
                    color: "#333",
                    family: "Arial, sans-serif",
                  },
                },
                xaxis: {
                  title: {
                    text: "Per√≠odo (Ano-M√™s)",
                    font: {
                      size: 14,
                      color: "#555",
                    },
                  },
                  tickangle: -45,
                  tickfont: {
                    size: 11,
                    color: "#666",
                  },
                  gridcolor: "#e1e5e9",
                  linecolor: "#c1c7cd",
                },
                yaxis: {
                  title: {
                    text: "Quantidade de Ciclos",
                    font: {
                      size: 14,
                      color: "#555",
                    },
                  },
                  tickfont: {
                    size: 11,
                    color: "#666",
                  },
                  gridcolor: "#e1e5e9",
                  linecolor: "#c1c7cd",
                  zeroline: false,
                },
                barmode: "stack",
                margin: {
                  l: 80,
                  r: 150,
                  t: 100,
                  b: 120,
                },
                height: 500,
                plot_bgcolor: "#fafbfc",
                paper_bgcolor: "#ffffff",
                bargap: 0.3,
                legend: {
                  x: 1.02,
                  y: 0.5,
                  xanchor: "left",
                  yanchor: "middle",
                  bgcolor: "rgba(255,255,255,0.8)",
                  bordercolor: "#ccc",
                  borderwidth: 1,
                  font: {
                    size: 12,
                    color: "#333",
                  },
                },
              };

              const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ["pan2d", "lasso2d"],
              };

              console.log(
                "üìä [FRONTEND] Criando gr√°fico empilhado com Plotly..."
              );
              const plotStart = performance.now();

              Plotly.newPlot("chart", plotData, layout, config).then(() => {
                const plotTime = performance.now() - plotStart;
                const totalTime = performance.now() - startTime;
                console.log(
                  `‚úÖ [FRONTEND] Gr√°fico empilhado criado em ${plotTime.toFixed(
                    2
                  )}ms`
                );
                console.log(
                  `üéâ [FRONTEND] Processo completo em ${totalTime.toFixed(2)}ms`
                );
              });
            })
            .catch((error) => {
              const errorTime = performance.now() - startTime;
              console.error(
                `‚ùå [FRONTEND] Erro ap√≥s ${errorTime.toFixed(2)}ms:`,
                error
              );
              console.error("‚ùå [FRONTEND] Stack trace:", error.stack);

              let errorMessage = error.message;
              if (
                error.name === "TypeError" &&
                error.message.includes("fetch")
              ) {
                errorMessage =
                  "Erro de conex√£o com o servidor. Verifique se o Flask est√° rodando.";
              }

              document.getElementById(
                "chart"
              ).innerHTML = `<div style="color: red; text-align: center; padding: 50px;">
                 <h3>Erro ao carregar dados</h3>
                 <p><strong>Mensagem:</strong> ${errorMessage}</p>
                 <p><strong>Tempo:</strong> ${errorTime.toFixed(2)}ms</p>
                 <p><small>Verifique o console para mais detalhes</small></p>
               </div>`;
            });
        }
      }

      // Load the default analysis
      document.addEventListener("DOMContentLoaded", function () {
        showAnalysis("cycles_by_year_month");
      });
    </script>
  </body>
</html>
